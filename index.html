import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, doc, deleteDoc, getDocs, setDoc } from 'firebase/firestore';
import { Send, User, Trash2, Loader, MessageSquare, AlertTriangle, Settings, Code, Zap, Users, Database, Edit, Crown, List, Globe, X, RefreshCw } from 'lucide-react'; 

// --- Firebase Global Variables (Mandatory) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Constants ---
const VERSION = "1.9.0"; // Code Refactor & UI Polish
const COOLDOWN_DURATION = 5;
const SUPER_ADMIN_ID = "15152491164772220861"; 
const ONLINE_THRESHOLD_SECONDS = 30;
const PRESENCE_UPDATE_INTERVAL = 10000;
const MAX_NICKNAME_LENGTH = 12;
const ADMIN_NICKNAME = "管理員";

// --- Path Helpers ---
const MESSAGE_COL_PATH = (appId) => `/artifacts/${appId}/public/data/messages`;
const CONFIG_DOC_PATH = (appId) => `/artifacts/${appId}/public/data/config/general`;
const BLOCKED_USERS_DOC_PATH = (appId) => `/artifacts/${appId}/public/data/config/blockedUsers`;
const PRESENCE_COL_PATH = (appId) => `/artifacts/${appId}/public/data/presence`;
const USER_PROFILE_COL_PATH = (appId) => `/artifacts/${appId}/public/data/user_profiles`;

// --- Utility ---
const isSuperAdmin = (userId) => userId === SUPER_ADMIN_ID;
const debounce = (func, delay) => {
    let timeoutId;
    return (...args) => {
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
};

// --- Styles ---
const GlobalStyles = () => (
    <>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
        <style jsx="true">{`
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans TC", sans-serif;
                background-color: #F5F5F7; /* Apple-like light gray */
                color: #1D1D1F;
            }
            .ios-card {
                background: #FFFFFF;
                border-radius: 18px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0,0,0,0.02);
                border: 1px solid rgba(0,0,0,0.03);
            }
            .ios-btn {
                transition: all 0.2s ease;
            }
            .ios-btn:active {
                transform: scale(0.96);
                opacity: 0.8;
            }
            .ios-input {
                background: #F5F5F7;
                border: 1px solid transparent;
                transition: all 0.2s ease;
            }
            .ios-input:focus {
                background: #FFFFFF;
                border-color: #007AFF;
                box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
            }
            .marquee-container {
                animation: marquee 20s linear infinite; 
            }
            @keyframes marquee {
                0%   { transform: translateX(100%); }
                100% { transform: translateX(-100%); }
            }
            .break-all-id { word-break: break-all; }
        `}</style>
    </>
);

// --- Sub-Components (Extracted for Performance & Readability) ---

const UserProfileSection = ({ userId, isAdmin, nickname, onUpdateNickname }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [tempName, setTempName] = useState(nickname);
    const [msg, setMsg] = useState(null);

    useEffect(() => { setTempName(nickname); }, [nickname]);

    const handleSave = async () => {
        const res = await onUpdateNickname(tempName);
        if (res.success) {
            setIsEditing(false);
            setMsg({ type: 'success', text: '已儲存' });
        } else {
            setMsg({ type: 'error', text: res.error });
        }
        setTimeout(() => setMsg(null), 3000);
    };

    if (!userId) return null;

    return (
        <div className="mt-4 p-5 ios-card flex flex-col gap-3">
            <div className="flex items-center justify-between flex-wrap gap-2">
                <span className="font-semibold text-gray-500 text-sm">我的暱稱</span>
                
                {isAdmin ? (
                     <div className="flex items-center space-x-2 bg-gray-100 px-3 py-1.5 rounded-full">
                        <span className="font-bold text-gray-900">{ADMIN_NICKNAME}</span>
                        <Crown size={14} className="text-yellow-500 fill-yellow-500" />
                        <span className="text-xs text-gray-400 font-medium">固定</span>
                    </div>
                ) : (
                    isEditing ? (
                        <div className="flex items-center gap-2 animate-in fade-in zoom-in duration-200">
                            <input
                                type="text"
                                value={tempName}
                                onChange={(e) => setTempName(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && handleSave()}
                                className="ios-input px-3 py-1.5 rounded-lg text-sm w-32 focus:outline-none"
                                placeholder="輸入暱稱"
                                maxLength={MAX_NICKNAME_LENGTH}
                                autoFocus
                            />
                            <button onClick={handleSave} className="p-1.5 bg-blue-500 text-white rounded-full ios-btn"><RefreshCw size={14}/></button>
                            <button onClick={() => { setIsEditing(false); setTempName(nickname); }} className="p-1.5 bg-gray-200 text-gray-600 rounded-full ios-btn"><X size={14}/></button>
                        </div>
                    ) : (
                        <button onClick={() => setIsEditing(true)} className="group flex items-center space-x-2 hover:bg-gray-100 px-3 py-1.5 rounded-full transition-colors">
                            <span className="font-bold text-gray-900">{nickname}</span>
                            <Edit size={14} className="text-gray-400 group-hover:text-blue-500" />
                        </button>
                    )
                )}
            </div>
            {msg && <div className={`text-xs text-center font-medium ${msg.type === 'error' ? 'text-red-500' : 'text-green-500'}`}>{msg.text}</div>}
            <div className="text-[10px] font-mono text-gray-400 border-t border-gray-100 pt-2 flex justify-between items-center">
                <span>ID</span>
                <span className="break-all-id text-gray-500 select-all">{userId}</span>
            </div>
        </div>
    );
};

const MessageItem = React.memo(({ message, currentUserId, currentUserIsAdmin, config, blockedUsers, onToggleBlock, onDelete }) => {
    const isOwner = message.userId === currentUserId;
    const isAuthorAdmin = isSuperAdmin(message.userId) || config.adminUserIds.includes(message.userId); 
    const canDelete = isOwner || currentUserIsAdmin; 
    const isTargetBlocked = blockedUsers.includes(message.userId); 
    
    const timeString = message.timestamp?.toLocaleString 
        ? message.timestamp.toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit' }) 
        : '發送中...';

    const bubbleStyle = isOwner 
        ? 'bg-blue-500 text-white rounded-br-none shadow-md border-blue-600' 
        : 'bg-white text-gray-800 rounded-bl-none shadow-sm border-gray-100 border';

    const alignStyle = isOwner ? 'flex-row-reverse' : 'flex-row';

    return (
        <div className={`flex ${alignStyle} items-end gap-2 mb-4 group`}>
            {/* Avatar */}
            <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-sm ${isOwner ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                {isAuthorAdmin ? <Crown size={14} className="fill-white text-white"/> : <User size={14} />}
            </div>

            {/* Message Content */}
            <div className={`max-w-[80%] flex flex-col ${isOwner ? 'items-end' : 'items-start'}`}>
                <div className="flex items-center gap-2 mb-1 px-1">
                    <span className={`text-xs font-bold ${isOwner ? 'text-gray-500' : isAuthorAdmin ? 'text-red-500' : 'text-gray-600'}`}>
                        {message.nickname || '訪客'}
                    </span>
                    {currentUserIsAdmin && !isOwner && (
                        <button onClick={() => onToggleBlock(message.userId)} className={`text-[10px] px-1.5 py-0.5 rounded border transition-colors ${isTargetBlocked ? 'bg-red-50 text-red-600 border-red-200' : 'bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100'}`}>
                            {isTargetBlocked ? '已封鎖' : '封鎖'}
                        </button>
                    )}
                </div>

                <div className={`px-4 py-2.5 rounded-2xl text-sm leading-relaxed whitespace-pre-wrap break-words ${bubbleStyle}`}>
                    {message.text}
                </div>
                
                <div className="flex items-center gap-2 mt-1 px-1">
                    <span className="text-[10px] text-gray-400">{timeString}</span>
                    {canDelete && (
                        <button onClick={() => onDelete(message.id, message.nickname)} className="text-gray-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                            <Trash2 size={12} />
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
});

const OnlineUsersList = ({ onlineUsers, currentUserId }) => (
    <div className="ios-card p-5 h-full max-h-[calc(100vh-100px)] flex flex-col">
        <h2 className="text-sm font-bold text-gray-500 mb-4 flex items-center uppercase tracking-wider">
            <List size={16} className="mr-2 text-green-500" /> 在線用戶 <span className="ml-auto bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">{onlineUsers.length}</span>
        </h2>
        <div className="flex-1 overflow-y-auto pr-1 space-y-1 custom-scrollbar">
            {onlineUsers.length === 0 ? (
                <div className="text-center py-10 text-gray-400 text-xs">沒有其他人在線</div>
            ) : (
                onlineUsers.map(user => (
                    <div key={user.id} className={`flex items-center justify-between p-2.5 rounded-xl transition-all ${user.id === currentUserId ? 'bg-blue-50/50' : 'hover:bg-gray-50'}`}>
                        <div className="flex items-center gap-3 min-w-0">
                            <div className={`w-2 h-2 rounded-full flex-shrink-0 ${user.id === currentUserId ? 'bg-blue-500' : 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]'}`}></div>
                            <div className="flex flex-col min-w-0">
                                <span className={`text-sm font-bold truncate flex items-center gap-1 ${user.isAdmin ? 'text-red-600' : 'text-gray-700'}`}>
                                    {user.nickname}
                                    {user.isAdmin && <Crown size={10} className="fill-red-600" />}
                                </span>
                                <span className="text-[10px] text-gray-400 font-mono truncate w-20">{user.id.substring(0, 8)}</span>
                            </div>
                        </div>
                    </div>
                ))
            )}
        </div>
    </div>
);

const AdminPanel = ({ config, userId, isAdmin, isSuperAdmin, blockedUsers, updateConfig, updateBlocked, manageAdminList, updateServerVersion, clearAll, adminMessage }) => {
    const [localConfig, setLocalConfig] = useState({ ...config });
    const [targetId, setTargetId] = useState('');
    const [verInput, setVerInput] = useState(config.latestServerVersion);

    useEffect(() => { setLocalConfig({ ...config }); setVerInput(config.latestServerVersion); }, [config]);

    const handleUpdate = (key, val) => updateConfig(key, val);
    
    if (!isAdmin) return null;

    return (
        <div className="mb-6 ios-card p-5 border-l-4 border-yellow-400 bg-yellow-50/30">
            <h3 className="font-bold text-yellow-800 mb-4 flex items-center"><Settings size={18} className="mr-2" /> 管理員控制台</h3>
            {adminMessage.text && <div className={`p-3 mb-4 rounded-xl text-xs font-bold ${adminMessage.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{adminMessage.text}</div>}
            
            <div className="grid gap-4 md:grid-cols-2">
                {/* Server & Maintenance */}
                <div className="space-y-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                    <div className="flex justify-between items-center">
                        <span className="text-xs font-bold text-gray-500 flex items-center"><Database size={14} className="mr-1"/> 維護模式</span>
                        <button onClick={() => handleUpdate('isMaintenanceMode', !localConfig.isMaintenanceMode)} className={`ios-btn px-3 py-1 rounded-full text-xs font-bold text-white ${localConfig.isMaintenanceMode ? 'bg-red-500' : 'bg-green-500'}`}>
                            {localConfig.isMaintenanceMode ? 'ON' : 'OFF'}
                        </button>
                    </div>
                    <textarea className="ios-input w-full p-2 rounded-lg text-xs h-16 resize-none" value={localConfig.maintenanceMessage} onChange={e => setLocalConfig({...localConfig, maintenanceMessage: e.target.value})} placeholder="維護公告..." />
                    <button onClick={() => handleUpdate('maintenanceMessage', localConfig.maintenanceMessage)} className="w-full py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-bold transition-colors">儲存公告</button>
                </div>

                {/* Marquee & Version */}
                <div className="space-y-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                    <div>
                        <label className="text-xs font-bold text-gray-500 block mb-1">跑馬燈</label>
                        <div className="flex gap-2">
                            <input className="ios-input flex-1 p-2 rounded-lg text-xs" value={localConfig.marqueeText} onChange={e => setLocalConfig({...localConfig, marqueeText: e.target.value})} />
                            <button onClick={() => handleUpdate('marqueeText', localConfig.marqueeText)} className="ios-btn px-3 bg-blue-500 text-white rounded-lg text-xs font-bold">更新</button>
                        </div>
                    </div>
                    {isSuperAdmin(userId) && (
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1 flex items-center"><Code size={12} className="mr-1"/> 版本控制</label>
                            <div className="flex gap-2">
                                <input className="ios-input flex-1 p-2 rounded-lg text-xs font-mono" value={verInput} onChange={e => setVerInput(e.target.value)} />
                                <button onClick={() => updateServerVersion(verInput)} className="ios-btn px-3 bg-purple-500 text-white rounded-lg text-xs font-bold">發布</button>
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {/* User Management (Super Admin) */}
             <div className="mt-4 grid gap-4 md:grid-cols-2">
                <div className="p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                     <label className="text-xs font-bold text-gray-500 block mb-2">封鎖名單 ({blockedUsers.length})</label>
                     <div className="max-h-24 overflow-y-auto space-y-1">
                        {blockedUsers.length === 0 && <p className="text-xs text-gray-300 italic">無封鎖用戶</p>}
                        {blockedUsers.map(id => (
                            <div key={id} className="flex justify-between items-center bg-gray-50 p-1.5 rounded-lg">
                                <span className="text-[10px] font-mono text-gray-600 truncate w-24">{id}</span>
                                <button onClick={() => updateBlocked(blockedUsers.filter(u => u !== id))} className="text-[10px] text-red-500 font-bold hover:underline">解除</button>
                            </div>
                        ))}
                     </div>
                </div>
                
                {isSuperAdmin(userId) && (
                     <div className="p-4 bg-white rounded-xl border border-gray-100 shadow-sm flex flex-col justify-between">
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-2">指派管理員</label>
                            <div className="flex gap-2 mb-2">
                                <input className="ios-input flex-1 p-2 rounded-lg text-[10px] font-mono" value={targetId} onChange={e => setTargetId(e.target.value)} placeholder="User ID" />
                                <button onClick={() => manageAdminList(targetId, 'add')} className="ios-btn px-2 bg-indigo-100 text-indigo-600 rounded-lg text-[10px] font-bold">+</button>
                                <button onClick={() => manageAdminList(targetId, 'remove')} className="ios-btn px-2 bg-red-100 text-red-600 rounded-lg text-[10px] font-bold">-</button>
                            </div>
                        </div>
                        <button onClick={clearAll} className="w-full py-2 mt-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold border border-red-100 hover:bg-red-100 transition-colors">
                            <Trash2 size={14} className="inline mr-1"/> 清空所有留言
                        </button>
                     </div>
                )}
             </div>
        </div>
    );
};

// --- Main Component ---

const App = () => {
    // --- State ---
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isDbReady, setIsDbReady] = useState(false);
    const [presenceCol, setPresenceCol] = useState(null); 
    
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [cooldown, setCooldown] = useState(0); 
    const [onlineUsersCount, setOnlineUsersCount] = useState(0); 
    const [onlineUsers, setOnlineUsers] = useState([]); 
    
    const [config, setConfig] = useState({ 
        marqueeText: '歡迎使用即時留言板！', 
        isMaintenanceMode: false,
        maintenanceMessage: '系統正在進行維護，請稍後再試。',
        adminUserIds: [],
        latestServerVersion: VERSION,
    });
    const [blockedUsers, setBlockedUsers] = useState([]); 
    const [adminMessage, setAdminMessage] = useState({ type: '', text: '' });
    
    const [showClearConfirm, setShowClearConfirm] = useState(false); 
    const [deleteTarget, setDeleteTarget] = useState(null); // { id, nickname }

    const [nickname, setNickname] = useState('訪客'); 
    const [isComposing, setIsComposing] = useState(false);

    const isAdmin = useMemo(() => isAuthReady && (isSuperAdmin(userId) || config.adminUserIds.includes(userId)), [isAuthReady, userId, config.adminUserIds]);
    const isOutdated = useMemo(() => VERSION !== config.latestServerVersion && config.latestServerVersion > VERSION, [config.latestServerVersion]);
    const isCurrentUserBlocked = blockedUsers.includes(userId);
    const canPost = isDbReady && userId && cooldown === 0 && !isCurrentUserBlocked && (!config.isMaintenanceMode || isAdmin) && !isOutdated; 

    // --- Initialization ---
    useEffect(() => {
        if (!firebaseConfig) return;
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);
            setDb(firestore);
            setPresenceCol(collection(firestore, PRESENCE_COL_PATH(appId)));

            onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) setUserId(user.uid);
                else {
                    try {
                        if (initialAuthToken) await signInWithCustomToken(firebaseAuth, initialAuthToken).then(u => setUserId(u.user.uid));
                        else await signInAnonymously(firebaseAuth).then(u => setUserId(u.user.uid));
                    } catch (e) { console.error(e); setError("身份驗證失敗"); }
                }
                setIsAuthReady(true);
            });
        } catch (e) { console.error(e); }
    }, []);

    // --- Hooks ---
    useEffect(() => {
        if (cooldown > 0) {
            const timer = setInterval(() => setCooldown(p => (p > 0 ? p - 1 : 0)), 1000);
            return () => clearInterval(timer);
        }
    }, [cooldown]);

    useEffect(() => {
        if (!db || !isAuthReady) return;
        if (!isDbReady) setIsLoading(true);
        
        const unsubMsg = onSnapshot(query(collection(db, MESSAGE_COL_PATH(appId))), (snapshot) => {
            const list = [];
            snapshot.forEach(d => list.push({ id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate ? d.data().timestamp.toDate() : new Date() }));
            setMessages(list.sort((a, b) => b.timestamp - a.timestamp));
            setIsLoading(false);
            setIsDbReady(true);
        });

        const unsubConfig = onSnapshot(doc(db, CONFIG_DOC_PATH(appId)), (snap) => {
            if (snap.exists()) setConfig(prev => ({ ...prev, ...snap.data() }));
            else setDoc(doc(db, CONFIG_DOC_PATH(appId)), config, { merge: true }).catch(()=>{});
        });

        const unsubBlocked = onSnapshot(doc(db, BLOCKED_USERS_DOC_PATH(appId)), (snap) => {
            if (snap.exists()) setBlockedUsers(snap.data().ids || []);
        });

        return () => { unsubMsg(); unsubConfig(); unsubBlocked(); };
    }, [db, isAuthReady]);

    useEffect(() => {
        if (!db || !userId) return;
        const presenceRef = doc(db, PRESENCE_COL_PATH(appId), userId);
        const updatePresence = () => setDoc(presenceRef, { lastSeen: Date.now(), nickname: isAdmin ? ADMIN_NICKNAME : nickname, isAdmin }, { merge: true }).catch(()=>{});
        updatePresence();
        const interval = setInterval(updatePresence, PRESENCE_UPDATE_INTERVAL);
        return () => clearInterval(interval);
    }, [db, userId, isAdmin, nickname]);

    useEffect(() => {
        if (!presenceCol) return;
        return onSnapshot(presenceCol, (snapshot) => {
            const threshold = Date.now() - (ONLINE_THRESHOLD_SECONDS * 1000);
            const active = [];
            let count = 0;
            snapshot.forEach(d => {
                const data = d.data();
                if (typeof data.lastSeen === 'number' && data.lastSeen >= threshold) {
                    count++;
                    active.push({ id: d.id, nickname: data.nickname || '載入中...', isAdmin: data.isAdmin || isSuperAdmin(d.id) || config.adminUserIds.includes(d.id) });
                }
            });
            setOnlineUsersCount(count);
            setOnlineUsers(active.sort((a, b) => a.isAdmin === b.isAdmin ? a.nickname.localeCompare(b.nickname) : a.isAdmin ? -1 : 1));
        });
    }, [presenceCol, config.adminUserIds]);

    useEffect(() => {
        if (!db || !userId) return;
        if (isAdmin) { setNickname(ADMIN_NICKNAME); return; }
        return onSnapshot(doc(db, USER_PROFILE_COL_PATH(appId), userId), (snap) => {
            setNickname(snap.exists() ? (snap.data().nickname || '訪客') : '訪客');
        });
    }, [db, userId, isAdmin]);

    // --- Handlers ---
    const addMessage = useCallback(debounce(async (text) => {
        if (!db || !userId) return;
        if (config.isMaintenanceMode && !isAdmin) return setError("維護中");
        if (blockedUsers.includes(userId)) return setError("已封鎖");
        if (isOutdated) return setError("請更新");

        const trimmed = text.trim();
        if (!trimmed) return;

        setCooldown(COOLDOWN_DURATION);
        try {
            await addDoc(collection(db, MESSAGE_COL_PATH(appId)), {
                userId, nickname: isAdmin ? ADMIN_NICKNAME : nickname, text: trimmed, timestamp: serverTimestamp()
            });
            setNewMessage('');
        } catch (e) { setError("發送失敗"); setCooldown(0); }
    }, 500), [db, userId, blockedUsers, nickname, isAdmin, config.isMaintenanceMode, isOutdated]);

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (canPost && !isComposing) addMessage(newMessage);
        }
    };

    const handleDelete = async () => {
        if (!deleteTarget) return;
        try { await deleteDoc(doc(db, MESSAGE_COL_PATH(appId), deleteTarget.id)); setDeleteTarget(null); } catch (e) { setError("刪除失敗"); }
    };

    const handleNicknameUpdate = async (newNick) => {
        if (isAdmin) return { success: false, error: "管理員無法更改暱稱" };
        const trimmed = newNick.trim();
        if (!trimmed || trimmed.length > MAX_NICKNAME_LENGTH) return { success: false, error: "長度不符" };
        try {
            await setDoc(doc(db, USER_PROFILE_COL_PATH(appId), userId), { nickname: trimmed }, { merge: true });
            return { success: true };
        } catch (e) { return { success: false, error: "更新失敗" }; }
    };

    // Admin Functions passed to panel
    const adminActions = {
        updateConfig: async (k, v) => isAdmin && setDoc(doc(db, CONFIG_DOC_PATH(appId)), { [k]: v }, { merge: true }),
        updateBlocked: async (ids) => isAdmin && setDoc(doc(db, BLOCKED_USERS_DOC_PATH(appId)), { ids }),
        clearAll: async () => { if (isSuperAdmin(userId)) { const s = await getDocs(collection(db, MESSAGE_COL_PATH(appId))); await Promise.all(s.docs.map(d => deleteDoc(d.ref))); setShowClearConfirm(false); } },
        updateServerVersion: async (v) => isSuperAdmin(userId) && setDoc(doc(db, CONFIG_DOC_PATH(appId)), { latestServerVersion: v }, { merge: true }),
        manageAdminList: async (tid, action) => {
            if (!isSuperAdmin(userId) || !tid) return;
            let newIds = [...config.adminUserIds];
            if (action === 'add' && !newIds.includes(tid)) newIds.push(tid);
            if (action === 'remove') newIds = newIds.filter(i => i !== tid);
            await setDoc(doc(db, CONFIG_DOC_PATH(appId)), { adminUserIds: newIds }, { merge: true });
        }
    };

    return (
        <div className="min-h-screen p-4 sm:p-8 text-gray-800 font-sans">
            <GlobalStyles />
            <div className="max-w-7xl mx-auto">
                {/* Outdated Alert */}
                {isOutdated && (
                    <div className="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r shadow-sm flex justify-between items-center">
                        <span className="font-bold text-yellow-800 flex items-center"><AlertTriangle className="mr-2"/> 版本過舊 ({VERSION} {'->'} {config.latestServerVersion})</span>
                        <button onClick={() => window.location.reload()} className="bg-yellow-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-yellow-600 transition-colors shadow">更新</button>
                    </div>
                )}

                {/* Header Area */}
                <header className="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 className="text-3xl font-black text-gray-900 tracking-tight flex items-center">
                            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white mr-3 shadow-lg shadow-blue-200">
                                <MessageSquare size={20} fill="currentColor" />
                            </div>
                            即時留言板
                        </h1>
                        <div className="flex gap-4 mt-2 text-xs font-medium text-gray-500 pl-1">
                             <span className="flex items-center"><Users size={12} className="mr-1 text-green-500"/> {onlineUsersCount} 在線</span>
                             <span className="flex items-center">
                                 <div className={`w-1.5 h-1.5 rounded-full mr-1.5 ${config.isMaintenanceMode ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                 {config.isMaintenanceMode ? '維護中' : '服務正常'}
                             </span>
                             <span className="bg-gray-200 px-1.5 py-0.5 rounded text-gray-600">v{VERSION}</span>
                        </div>
                    </div>
                    <div className="w-full md:w-auto">
                        <div className="ios-card px-4 py-2 flex items-center justify-between md:justify-start gap-4 bg-white">
                            <div className="flex items-center gap-2 text-sm font-bold text-indigo-600">
                                <Zap size={16} fill="currentColor" className="text-yellow-400" />
                                公告
                            </div>
                            <div className="h-5 overflow-hidden relative flex-1 w-48">
                                <div className="marquee-container whitespace-nowrap absolute text-xs font-medium text-gray-600">
                                    {config.marqueeText}
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <div className="flex flex-col lg:flex-row gap-8">
                    {/* LEFT COLUMN */}
                    <div className="lg:w-2/3 space-y-6">
                        <AdminPanel 
                            config={config} userId={userId} isAdmin={isAdmin} isSuperAdmin={isSuperAdmin} blockedUsers={blockedUsers} 
                            adminMessage={adminMessage} setAdminMessage={setAdminMessage} setShowClearConfirm={setShowClearConfirm}
                            {...adminActions} 
                        />

                        {/* Input Box */}
                        <div className="ios-card p-5 relative z-10">
                             <textarea
                                value={newMessage}
                                onChange={e => !isComposing && setNewMessage(e.target.value)}
                                onCompositionStart={() => setIsComposing(true)}
                                onCompositionEnd={(e) => { setIsComposing(false); setNewMessage(e.target.value); }}
                                onKeyDown={handleKeyDown}
                                placeholder={config.isMaintenanceMode && !isAdmin ? "系統維護中，暫時無法留言..." : `以 ${isAdmin ? ADMIN_NICKNAME : nickname} 的身份留言...`}
                                className="ios-input w-full p-4 rounded-xl outline-none resize-none text-gray-700 placeholder-gray-400 text-base min-h-[100px]"
                                disabled={!canPost}
                            />
                            <div className="flex justify-between items-center mt-3">
                                <div className="text-xs font-medium text-gray-400">
                                    {isCurrentUserBlocked ? <span className="text-red-500">您已被封鎖</span> : 
                                     config.isMaintenanceMode && !isAdmin ? <span className="text-yellow-600">維護模式</span> :
                                     <span>Enter 送出 · {newMessage.length}/500</span>}
                                </div>
                                <button 
                                    onClick={() => canPost && addMessage(newMessage)} 
                                    disabled={!canPost}
                                    className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-6 py-2 text-sm font-bold shadow-lg shadow-blue-200 transition-all active:scale-95 disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed flex items-center"
                                >
                                    {cooldown > 0 ? `${cooldown}s` : <><Send size={16} className="mr-2" /> 發送</>}
                                </button>
                            </div>
                        </div>

                        {/* Messages */}
                        <div className="space-y-5 pb-20">
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-xl text-sm font-medium text-center border border-red-100">{error}</div>}
                            
                            {isLoading ? (
                                <div className="flex justify-center py-12"><Loader className="animate-spin text-gray-300" /></div>
                            ) : messages.length === 0 ? (
                                <div className="text-center py-12 text-gray-400 text-sm bg-white rounded-2xl border border-dashed border-gray-200">
                                    <MessageSquare size={32} className="mx-auto mb-2 opacity-20" />
                                    還沒有人留言，快來搶頭香！
                                </div>
                            ) : (
                                messages.map(msg => (
                                    <MessageItem 
                                        key={msg.id} 
                                        message={msg} 
                                        currentUserId={userId} 
                                        currentUserIsAdmin={isAdmin} 
                                        config={config} 
                                        blockedUsers={blockedUsers} 
                                        onToggleBlock={adminActions.updateBlocked ? id => adminActions.updateBlocked(blockedUsers.includes(id) ? blockedUsers.filter(u=>u!==id) : [...blockedUsers, id]) : null}
                                        onDelete={(id, nick) => setDeleteTarget({id, nickname: nick})}
                                    />
                                ))
                            )}
                        </div>
                    </div>

                    {/* RIGHT COLUMN */}
                    <div className="lg:w-1/3 space-y-6">
                        <UserProfileSection userId={userId} isAdmin={isAdmin} nickname={nickname} onUpdateNickname={handleNicknameUpdate} />
                        <OnlineUsersList onlineUsers={onlineUsers} currentUserId={userId} />
                    </div>
                </div>
            </div>

            {/* Modals */}
            {deleteTarget && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl transform scale-100 transition-all">
                        <h3 className="text-lg font-bold text-gray-900 mb-2">確認刪除？</h3>
                        <p className="text-sm text-gray-500 mb-6">您確定要刪除 <b>{deleteTarget.nickname}</b> 的這則留言嗎？</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={() => setDeleteTarget(null)} className="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">取消</button>
                            <button onClick={handleDelete} className="px-4 py-2 bg-red-500 text-white rounded-xl text-sm font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition-colors">確認刪除</button>
                        </div>
                    </div>
                </div>
            )}

            {showClearConfirm && (
                 <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl border-t-4 border-red-500">
                        <h3 className="text-lg font-bold text-red-600 mb-2 flex items-center"><AlertTriangle className="mr-2"/> 危險操作</h3>
                        <p className="text-sm text-gray-500 mb-6">將永久刪除<b>所有留言</b>，此操作無法復原。</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={() => setShowClearConfirm(false)} className="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl text-sm font-bold hover:bg-gray-200">取消</button>
                            <button onClick={() => adminActions.clearAll()} className="px-4 py-2 bg-red-600 text-white rounded-xl text-sm font-bold hover:bg-red-700 shadow-lg">確認清空</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default App;