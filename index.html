<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時多功能留言板</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 Lucide Icons (用於美觀的圖標) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Noto Sans TC (確保中文字體顯示良好) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .main-card {
            background: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .marquee-wrapper {
            overflow: hidden;
            width: 100%;
        }
        .marquee-container {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .break-all-id {
            word-break: break-all;
        }
        .message-list::-webkit-scrollbar { width: 6px; }
        .message-list::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .message-list::-webkit-scrollbar-track { background: #f3f4f6; }
        .soft-shadow {
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-5xl mx-auto">
        <!-- 初始載入指示器 -->
        <div id="loading-spinner" class="flex justify-center items-center h-[50vh]">
            <div class="text-xl font-bold text-gray-400 flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                正在連線至 Firebase...
            </div>
        </div>
    </div>
    
    <!-- 刪除確認 Modal 容器 -->
    <div id="modal-delete" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4"></div>

    <!-- 清空確認 Modal 容器 -->
    <div id="modal-clear" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, doc, deleteDoc, setDoc, getDocs, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Canvas Mandatory) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Constants ---
        const VERSION = "1.0.0"; 
        const MAX_MESSAGE_LENGTH = 300;
        const ADMIN_USER_IDS = ["your_admin_user_id_here"]; // 預留給外部環境配置
        const MESSAGE_COL_NAME = 'guestbook_messages';

        // --- Firebase Instances ---
        let app, db, auth;
        let unsubscribeListeners = [];

        // --- Global State ---
        const state = {
            userId: null,
            isAdmin: false,
            messages: [],
            config: { 
                marqueeText: '歡迎使用即時留言板！', 
                isMaintenanceMode: false,
                maintenanceMessage: '系統正在進行維護，請稍後再試。',
                adminUserIds: ADMIN_USER_IDS,
                latestServerVersion: VERSION,
            },
            error: null,
            isLoading: true,
            isAuthReady: false,
            newMessage: '',
            newNickname: '',
            deleteTarget: null, // { id, userId }
            showClearConfirm: false,
        };

        // --- Path Helpers ---
        // 公共留言集合路徑
        const MESSAGE_COL_PATH = (appId) => collection(db, 'artifacts', appId, 'public', 'data', MESSAGE_COL_NAME);
        // 公共配置文檔路徑
        const CONFIG_DOC_PATH = (appId) => doc(db, 'artifacts', appId, 'public', 'data', 'config', 'general');
        
        // --- DOM Elements Reference ---
        const els = {};

        /**
         * 簡單的 DOM 創建輔助函數 (Hypertext helper)
         * @param {string} tag 
         * @param {object} props 
         * @param {(HTMLElement|string)[]} children 
         * @returns {HTMLElement}
         */
        const h = (tag, props = {}, children = []) => {
            const el = document.createElement(tag);
            Object.keys(props).forEach(key => {
                if (key.startsWith('on') && typeof props[key] === 'function') {
                    el.addEventListener(key.substring(2).toLowerCase(), props[key]);
                } else if (key === 'className') {
                    el.className = props[key];
                } else if (key === 'dataset') {
                    Object.keys(props.dataset).forEach(dataKey => el.dataset[dataKey] = props.dataset[dataKey]);
                } else {
                    el.setAttribute(key, props[key]);
                }
            });
            children.forEach(child => {
                if (typeof child === 'string') {
                    el.appendChild(document.createTextNode(child));
                } else if (child instanceof Node) {
                    el.appendChild(child);
                }
            });
            return el;
        };

        /**
         * 檢查是否為管理員
         * @param {string} userId 
         * @returns {boolean}
         */
        const checkIsAdmin = (userId) => {
            return userId && state.config.adminUserIds.includes(userId);
        };
        
        /**
         * 更新狀態並觸發重新渲染
         * @param {object} newState 
         */
        const setState = (newState) => {
            Object.assign(state, newState);
            renderApp();
        };

        /**
         * 格式化 Firestore Timestamp
         * @param {Object} timestamp - Firestore Timestamp object
         * @returns {string} 
         */
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return '時間未知';
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // --- Listeners ---

        /**
         * 監聽公共配置文檔
         */
        function listenForConfig() {
            if (!db) return;
            const configRef = CONFIG_DOC_PATH(appId);
            const unsubscribe = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    setState({ config: { ...state.config, ...docSnap.data() } });
                } else {
                    // 如果配置文檔不存在，創建一個預設文檔
                    setDoc(configRef, state.config, { merge: true }).catch(err => console.error("Error creating initial config:", err));
                }
                // 檢查管理員權限
                setState({ isAdmin: checkIsAdmin(state.userId) });
            }, (error) => {
                console.error("Error listening to config:", error);
                setState({ error: '無法載入配置。' });
            });
            unsubscribeListeners.push(unsubscribe);
        }

        /**
         * 監聽留言列表
         */
        function listenForMessages() {
            if (!db) return;
            const messagesRef = MESSAGE_COL_PATH(appId);
            // 由於 Firestore 不推薦無索引的 orderBy，我們只獲取數據並在客戶端排序
            const q = query(messagesRef);

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // 客戶端排序：按時間戳記降序 (最新在最前面)
                messages.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                setState({ messages: messages });
            }, (error) => {
                console.error("Error listening to messages:", error);
                setState({ error: '無法載入留言列表。' });
            });
            unsubscribeListeners.push(unsubscribe);
        }
        
        // --- Handlers ---
        
        /**
         * 處理刪除留言
         * @param {string} messageId 
         */
        async function handleDeleteMessage(messageId) {
            if (!db || !messageId || !state.userId) return;
            try {
                const messageRef = doc(MESSAGE_COL_PATH(appId), messageId);
                await deleteDoc(messageRef);
                document.getElementById('modal-delete').classList.add('hidden');
                setState({ deleteTarget: null });
            } catch (error) {
                console.error("Error deleting message:", error);
                alert('刪除失敗: ' + error.message);
            }
        }

        /**
         * 處理發送新留言
         * @param {Event} e 
         */
        async function handlePostMessage(e) {
            e.preventDefault();
            const nickname = els.nicknameInput.value.trim() || '匿名用戶';
            const message = els.messageInput.value.trim();

            if (state.config.isMaintenanceMode && !state.isAdmin) {
                alert(state.config.maintenanceMessage);
                return;
            }

            if (!message) {
                alert('留言內容不能為空！');
                return;
            }

            if (message.length > MAX_MESSAGE_LENGTH) {
                alert(`留言長度不能超過 ${MAX_MESSAGE_LENGTH} 字元。`);
                return;
            }
            
            els.submitButton.disabled = true;
            els.submitButton.textContent = '發送中...';

            try {
                await addDoc(MESSAGE_COL_PATH(appId), {
                    name: nickname,
                    message: message,
                    timestamp: serverTimestamp(),
                    userId: state.userId,
                });

                els.messageInput.value = '';
            } catch (error) {
                console.error("Error posting message:", error);
                alert('發送留言失敗: ' + error.message);
            } finally {
                els.submitButton.disabled = false;
                els.submitButton.textContent = '送出留言';
            }
        }

        /**
         * 處理管理員清空所有留言
         */
        async function handleClearAllMessages() {
            if (!state.isAdmin) return;
            
            document.getElementById('modal-clear').classList.add('hidden');
            
            try {
                const messagesSnapshot = await getDocs(MESSAGE_COL_PATH(appId));
                const deletePromises = [];
                messagesSnapshot.forEach(d => {
                    deletePromises.push(deleteDoc(doc(MESSAGE_COL_PATH(appId), d.id)));
                });
                await Promise.all(deletePromises);
                alert('所有留言已成功清空！');
            } catch (error) {
                console.error("Error clearing messages:", error);
                alert('清空留言失敗: ' + error.message);
            }
        }

        // --- Render Components ---

        /**
         * 渲染單一留言卡片
         * @param {Object} msg 
         * @returns {HTMLElement}
         */
        function renderMessageCard(msg) {
            const isCurrentUser = msg.userId === state.userId;
            const isAuthorizedToDelete = isCurrentUser || state.isAdmin;

            const card = h('div', {
                className: `p-4 rounded-xl soft-shadow transition duration-200 relative ${
                    isCurrentUser 
                    ? 'bg-indigo-100 border-l-4 border-indigo-500' 
                    : 'bg-white border-l-4 border-gray-200'
                }`
            }, [
                // Header: Nickname and Timestamp
                h('div', { className: 'flex justify-between items-start mb-1' }, [
                    h('div', { className: 'flex flex-col' }, [
                        h('span', { 
                            className: `font-bold text-lg ${isCurrentUser ? 'text-indigo-800' : 'text-gray-800'}`
                        }, [
                            msg.name || '匿名用戶',
                            isCurrentUser ? h('span', { className: 'ml-2 text-xs font-normal text-indigo-500' }, '(您)') : '',
                        ]),
                        h('span', { className: 'text-xs text-gray-400 break-all-id' }, [`ID: ${msg.userId || '未知'}`])
                    ]),
                    h('span', { className: 'text-xs text-gray-500 whitespace-nowrap' }, [formatTimestamp(msg.timestamp)])
                ]),
                
                // Content
                h('p', { className: 'text-gray-600 whitespace-pre-wrap mt-2' }, [msg.message]),

                // Delete Button (only for admin or self)
                isAuthorizedToDelete ? h('button', {
                    className: 'absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 transition',
                    title: '刪除留言',
                    onclick: () => setState({ deleteTarget: { id: msg.id, userId: msg.userId } })
                }, [
                    h('i', { className: 'lucide lucide-trash-2 w-4 h-4', 'data-lucide': 'trash-2' })
                ]) : ''
            ]);
            
            // Render Lucide icons manually after creation
            setTimeout(() => {
                const icons = card.querySelectorAll('[data-lucide]');
                icons.forEach(icon => lucide.createIcons({ icons: { 'trash-2': lucide.icons['trash-2'] }, attrs: { class: icon.className, 'data-lucide': icon.dataset.lucide } }));
            }, 0);

            return card;
        }

        /**
         * 渲染管理面板
         * @returns {HTMLElement}
         */
        function renderAdminPanel() {
            if (!state.isAdmin) return h('div');

            return h('div', { className: 'mt-8 p-6 bg-red-50 border border-red-200 rounded-xl shadow-inner' }, [
                h('h2', { className: 'text-2xl font-bold text-red-700 mb-4 flex items-center' }, [
                    h('i', { className: 'lucide lucide-shield-half mr-2 w-5 h-5', 'data-lucide': 'shield-half' }),
                    '管理員控制台'
                ]),
                
                // 維護模式
                h('div', { className: 'space-y-3 p-4 bg-white rounded-lg soft-shadow mb-4' }, [
                    h('h3', { className: 'text-lg font-semibold text-red-600' }, ['系統維護模式']),
                    h('div', { className: 'flex space-x-2' }, [
                        els.adminMaintMsg = h('input', {
                            type: 'text',
                            placeholder: state.config.maintenanceMessage || '系統維護中...',
                            className: 'flex-grow px-3 py-2 border rounded-lg focus:ring-red-500'
                        }),
                        h('button', {
                            id: 'btn-maint-on',
                            className: 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition'
                        }, ['開啟維護']),
                        h('button', {
                            id: 'btn-maint-off',
                            className: 'px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition'
                        }, ['關閉維護']),
                    ]),
                    h('p', { className: `text-sm font-medium ${state.config.isMaintenanceMode ? 'text-red-600' : 'text-green-600'}` }, [
                        '當前狀態：',
                        state.config.isMaintenanceMode ? '已開啟' : '已關閉'
                    ])
                ]),

                // 跑馬燈
                h('div', { className: 'space-y-3 p-4 bg-white rounded-lg soft-shadow mb-4' }, [
                    h('h3', { className: 'text-lg font-semibold text-red-600' }, ['跑馬燈公告']),
                    h('div', { className: 'flex space-x-2' }, [
                        els.adminMarqueeInput = h('input', {
                            type: 'text',
                            placeholder: state.config.marqueeText,
                            className: 'flex-grow px-3 py-2 border rounded-lg focus:ring-red-500'
                        }),
                        h('button', {
                            id: 'btn-update-marquee',
                            className: 'px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition'
                        }, ['更新跑馬燈'])
                    ])
                ]),

                // 清空留言
                h('div', { className: 'mt-6 pt-4 border-t border-red-200 flex justify-end' }, [
                    h('button', {
                        id: 'btn-confirm-clear-open',
                        className: 'px-4 py-2 bg-red-700 text-white rounded-lg font-semibold hover:bg-red-800 transition'
                    }, ['清空所有留言'])
                ]),
            ]);
        }

        /**
         * 渲染刪除確認 Modal
         * @returns {HTMLElement}
         */
        function renderDeleteModal() {
            const modal = document.getElementById('modal-delete');
            if (!state.deleteTarget) {
                modal.classList.add('hidden');
                return;
            }

            modal.classList.remove('hidden');
            
            const targetId = state.deleteTarget.id;
            const targetUserId = state.deleteTarget.userId;

            modal.innerHTML = '';
            modal.appendChild(h('div', { className: 'bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm' }, [
                h('h3', { className: 'text-xl font-bold text-gray-800 mb-4' }, ['確認刪除']),
                h('p', { className: 'text-gray-600 mb-6' }, [
                    '您確定要刪除這則留言嗎？',
                    h('br'),
                    h('span', { className: 'text-sm text-red-500 break-all-id' }, [`ID: ${targetId}`])
                ]),
                h('div', { className: 'flex justify-end space-x-3' }, [
                    h('button', {
                        className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition',
                        onclick: () => setState({ deleteTarget: null })
                    }, ['取消']),
                    h('button', {
                        className: 'px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition',
                        onclick: () => handleDeleteMessage(targetId)
                    }, ['確定刪除'])
                ])
            ]));
        }

        /**
         * 渲染清空確認 Modal
         * @returns {HTMLElement}
         */
        function renderClearModal() {
            const modal = document.getElementById('modal-clear');
            
            modal.innerHTML = '';
            modal.appendChild(h('div', { className: 'bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm' }, [
                h('h3', { className: 'text-xl font-bold text-red-700 mb-4' }, ['⚠️ 警告：清空所有留言']),
                h('p', { className: 'text-gray-600 mb-6' }, [
                    '這將會永久刪除所有用戶發布的留言，此操作無法撤銷。您確定要繼續嗎？'
                ]),
                h('div', { className: 'flex justify-end space-x-3' }, [
                    h('button', {
                        id: 'btn-cancel-clear',
                        className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition',
                        onclick: () => modal.classList.add('hidden')
                    }, ['取消']),
                    h('button', {
                        id: 'btn-do-clear',
                        className: 'px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition',
                        onclick: handleClearAllMessages
                    }, ['確認清空'])
                ])
            ]));

             // Attach listener to open button after main render
            if (state.isAdmin) {
                document.getElementById('btn-confirm-clear-open').onclick = () => modal.classList.remove('hidden');
            }
        }

        /**
         * 主渲染函數，用於更新 UI 的各個部分
         */
        function renderApp() {
            const appEl = document.getElementById('app');
            if (state.isLoading) return; 

            // 移除載入指示器
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.remove();

            // 主應用程式結構
            if (!document.getElementById('main-content')) {
                appEl.innerHTML = `
                    <div id="main-content" class="main-card p-6 md:p-10">
                        <!-- Header -->
                        <header class="text-center mb-6">
                            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">即時公共留言板</h1>
                            <p id="user-info" class="text-sm text-gray-500 mt-1 break-all-id"></p>
                            <p id="version-info" class="text-xs text-gray-400 mt-1">版本: ${VERSION} / 服務器版本: ${state.config.latestServerVersion}</p>
                        </header>

                        <!-- Marquee -->
                        <div id="marquee-banner" class="mb-6 py-2 px-4 bg-yellow-100 text-yellow-800 font-semibold rounded-lg overflow-hidden soft-shadow">
                            <div class="marquee-wrapper">
                                <div id="marquee-text" class="marquee-container"></div>
                            </div>
                        </div>

                        <!-- Maintenance Mode Alert -->
                        <div id="maint-alert" class="hidden mb-6 p-4 bg-red-100 border border-red-300 text-red-700 rounded-lg font-medium"></div>

                        <!-- Main Grid Layout -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left: Post Form -->
                            <div class="order-2 lg:order-1">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">發表新留言</h2>
                                <form id="post-form" class="p-6 bg-indigo-50 rounded-xl shadow-inner space-y-4"></form>
                            </div>
                            <!-- Right: Message List -->
                            <div class="order-1 lg:order-2">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">所有留言 (${state.messages.length} 則)</h2>
                                <div id="messages-list" class="message-list h-[500px] overflow-y-auto space-y-4 p-2 bg-gray-50 rounded-xl border border-gray-200"></div>
                            </div>
                        </div>

                        <!-- Admin Panel Container -->
                        <div id="admin-panel-container"></div>
                    </div>
                `;
                // 設置 DOM 元素的引用
                els.userInfo = document.getElementById('user-info');
                els.marqueeText = document.getElementById('marquee-text');
                els.maintAlert = document.getElementById('maint-alert');
                els.messagesList = document.getElementById('messages-list');
                els.postForm = document.getElementById('post-form');
                els.adminPanelContainer = document.getElementById('admin-panel-container');

                // 渲染表單
                els.postForm.innerHTML = '';
                els.postForm.appendChild(h('div', { className: 'space-y-4' }, [
                    h('label', { className: 'block text-sm font-medium text-gray-700' }, ['暱稱']),
                    els.nicknameInput = h('input', {
                        type: 'text',
                        placeholder: '可選填 (預設: 匿名用戶)',
                        className: 'w-full px-4 py-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm',
                        maxLength: 12
                    }),
                    h('label', { className: 'block text-sm font-medium text-gray-700 mt-2' }, [`留言內容 (限 ${MAX_MESSAGE_LENGTH} 字)`]),
                    els.messageInput = h('textarea', {
                        rows: 4,
                        required: true,
                        placeholder: '請輸入您的留言...',
                        className: 'w-full px-4 py-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm resize-none',
                        maxLength: MAX_MESSAGE_LENGTH
                    }),
                    els.submitButton = h('button', {
                        type: 'submit',
                        className: 'w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed',
                        disabled: !state.isAuthReady
                    }, [state.isAuthReady ? '送出留言' : '正在初始化...'])
                ]));
                els.postForm.onsubmit = handlePostMessage;
            }

            // --- Dynamic Updates ---

            // 1. 更新使用者 ID
            els.userInfo.textContent = `當前用戶 ID: ${state.userId || '連線中...'}`;

            // 2. 更新跑馬燈
            els.marqueeText.textContent = state.config.marqueeText;
            
            // 3. 更新維護模式警報
            if (state.config.isMaintenanceMode) {
                els.maintAlert.classList.remove('hidden');
                els.maintAlert.textContent = `⚠️ 系統公告：${state.config.maintenanceMessage}`;
            } else {
                els.maintAlert.classList.add('hidden');
            }

            // 4. 更新留言列表
            els.messagesList.innerHTML = '';
            if (state.messages.length === 0) {
                els.messagesList.appendChild(h('p', { className: 'text-center text-gray-500 p-4' }, ['目前沒有留言。']));
            } else {
                state.messages.forEach(msg => {
                    els.messagesList.appendChild(renderMessageCard(msg));
                });
                // 保持滾動到底部
                els.messagesList.scrollTop = els.messagesList.scrollHeight;
            }
            
            // 5. 更新管理面板
            els.adminPanelContainer.innerHTML = '';
            els.adminPanelContainer.appendChild(renderAdminPanel());

            // 6. 渲染 Modals
            renderDeleteModal();
            renderClearModal();

            // 確保 Lucide Icons 在管理面板渲染後創建
            lucide.createIcons();

            // 7. 重新掛載管理員按鈕事件 (需要在元素存在後)
            if (state.isAdmin) {
                // Marquee
                document.getElementById('btn-update-marquee').onclick = async () => {
                    const val = els.adminMarqueeInput.value.trim();
                    if (val) await setDoc(CONFIG_DOC_PATH(appId), { marqueeText: val }, { merge: true });
                };
                // Maintenance ON
                document.getElementById('btn-maint-on').onclick = async () => {
                    const msg = els.adminMaintMsg.value || '系統維護中...';
                    await setDoc(CONFIG_DOC_PATH(appId), { isMaintenanceMode: true, maintenanceMessage: msg }, { merge: true });
                };
                // Maintenance OFF
                document.getElementById('btn-maint-off').onclick = async () => {
                    await setDoc(CONFIG_DOC_PATH(appId), { isMaintenanceMode: false }, { merge: true });
                };
            }
        }

        /**
         * 初始化所有 Firebase 服務並設置監聽器
         */
        async function initializeAppAndListeners() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500 text-center text-lg">錯誤：Firebase 設定遺失。請提供設定。</p>`;
                return;
            }

            try {
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 執行身份驗證
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 監聽認證狀態變化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setState({ 
                            userId: user.uid, 
                            isAuthReady: true,
                            isAdmin: checkIsAdmin(user.uid), // 第一次檢查管理員權限
                            isLoading: false, 
                        });
                        
                        // 認證完成後，開始監聽資料
                        listenForConfig();
                        listenForMessages();
                    } else {
                         // 匿名登入失敗或登出
                         setState({ userId: '未知', isAuthReady: true, isLoading: false });
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化或登入失敗:", error);
                document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500 text-center text-lg">初始化失敗：${error.message}</p>`;
                setState({ error: '初始化失敗', isLoading: false });
            }
        }

        // 頁面載入完成後初始化
        window.onload = initializeAppAndListeners;
    </script>
</body>
</html>
